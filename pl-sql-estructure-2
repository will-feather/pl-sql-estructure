-- SINTAXE PARA CRIAÇÃO DE PROCEDURE (PROCEDURAL LANGUAGE) --

/*
CREATE OR REPLACE PROCEDURE NOME_PROCEDURE(PARAMETROS)
LANGUAGE PLSQL AS $$
DECLARE
	DECLARACAO DE VARIAVEIS;
BEGIN 
	CORPO DO CODIGO;
END $$;
*/

-- TABELA DE EXEMPLO

CREATE TABLE TB_CONTAS (
	ID INT,
	NOME VARCHAR(100),
	SALDO DECIMAL
);

SELECT * FROM TB_CONTAS;

INSERT INTO TB_CONTAS (ID, NOME, SALDO) VALUES (1, 'ANA', 5000);
INSERT INTO TB_CONTAS (ID, NOME, SALDO) VALUES (2, 'BRUNO', 10000);

-- PROCEDURE PARA REGISTRO DE TRANSAÇÃO FINANCEIRA

CREATE OR REPLACE PROCEDURE SP_TRANSFERENCIA(V_ORIGEM INT, V_DESTINO INT, V_VALOR DECIMAL) IS
BEGIN 
	-- SUBTRAINDO O MONTANTE DA CONTA ORIGEM
	UPDATE TB_CONTAS SET SALDO = SALDO - V_VALOR WHERE ID = V_ORIGEM;
	-- ADICIONA O MONTANTE NA CONTA DESTINO
	UPDATE TB_CONTAS SET SALDO = SALDO + V_VALOR WHERE ID = V_DESTINO;
END SP_TRANSFERENCIA;


-- EXECUÇÃO PROCEDURE

DECLARE
BEGIN
 SP_TRANSFERENCIA(1, 2, 300);
END;
-- OR
CALL SP_TRANSFERENCIA(1, 2, 300);


-- TRIGGER PARA ABORTAR OPERAÇÃO EM CASO DE DIA DEFINIDO

SELECT TRIM(TO_CHAR(SYSDATE, 'DAY')) FROM DUAL;

CREATE OR REPLACE TRIGGER TG_CONTAS_BEFORE_DML
BEFORE INSERT OR UPDATE OR DELETE
ON TB_CONTAS
BEGIN 
	IF TRIM(TO_CHAR(SYSDATE, 'DAY')) IN ('SÁBADO', 'DOMINGO', 'TERÇA-FEIRA') THEN 
		RAISE_APPLICATION_ERROR(-20001, 'NÃO É POSSÍVEL REALIZAR ALTERAÇÕES EM '|| TRIM(TO_CHAR(SYSDATE, 'DAY')) || 'S');
	END IF;
END;

DELETE FROM TB_CONTAS WHERE ID = 2;

-- HABILITAR OU DESABILITAR TRIGGER

ALTER TRIGGER TG_CONTAS_BEFORE_DML DISABLE;
ALTER TRIGGER TG_CONTAS_BEFORE_DML ENABLE;

-- EXCLUIR TRIGGER

DROP TRIGGER TG_CONTAS_BEFORE_DML;
